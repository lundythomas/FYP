<!DOCTYPE html>
<html>

  <head>

    <title> Test 10</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="style1.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  </head>

<body>

  <div class="jumbotron text-center">
  <h1>Temp & Humidity Readings</h1>
  <p>Thomas Lundy's FYP</p>
</div>

<div id="con" class="container">
  <div class="row align-items-center">
    <div class="col-lg-12">
      <h3>Temperature - Office</h3>
      <div id="test1"></div>
    </div>
    <div class="col-lg-12">
      <h3>Humidity - Office</h3>
      <div id="test2"></div>
      <div></div>
    </div>
    <div class="col-lg-12">
      <h3>Time Collected</h3>
      <div id ="timeCollected"></div>
    </div>
  </div>
</div>

   <script type="text/javascript">
      google.charts.load('current', {'packages':['gauge']});
      google.charts.setOnLoadCallback(tempGauge);
      google.charts.setOnLoadCallback(humGauge);

      function tempGauge() {

        var data = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['Temp', 10],
        ]);

        var options = {
          width: 400, height: 120,
          redFrom: 35, redTo: 50,
          yellowFrom:30, yellowTo: 35,
          greenFrom: 15, greenTo: 30,
          minorTicks: 5, max: 50
        };

        var chart = new google.visualization.Gauge(document.getElementById('test1'));

        chart.draw(data, options);
      }

      function humGauge() {

        var data = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['Humidity', 80],
        ]);

        var options = {
          width: 400, height: 120,
          redFrom: 80, redTo: 100,
          yellowFrom:60, yellowTo: 80,
          greenFrom: 0, greenTo: 60,
          minorTicks: 5, max: 100
        };

        var chart = new google.visualization.Gauge(document.getElementById('test2'));

        chart.draw(data, options);
      }

  </script>

  <script>

      var latestTime;
      var updatedData;
      var tempNew1;
      var humNew1;
      var currTemp1;
      var currHum1;

      function roundToTwo(num) // function that rounds to two decimal points.
      {
      return +(Math.round(num + "e+2")  + "e-2");
      }

      $(document).ready(getLatestData);

      function getLatestData() //functaion that retrives the lastest data from the db.
      {
      $.getJSON("http://sbsrv1.cs.nuim.ie/lora/list.php?node=08-00-AA-00-C0-22-04-08&format=json", function(l)
      {

        latestTime = l[0].ts;
        var latestData = l[0].data;
        var len = l[0].data.length;

        if (len==6)  // This separates the data into the temp and humidity.
        {
          var tempNew1 = latestData.substring(0, 3);
          var humNew1 = latestData.substring(3, 7);
        }
        else if (len==8) //This is for when the temp and or humidity are above a certain figure.
        {
          var tempNew1 = latestData.substring(0, 4);
          var humNew1 = latestData.substring(4, 8);
        }
        else
        {
          console.log("There is something wrong with your data array length");
        }

        var currTemp1 = (parseInt(tempNew1, 16)/100);
        var currHum1 = (parseInt(humNew1, 16)/100);

        //document.getElementById("tempShow").innerHTML = roundToTwo(currTemp1);
        //document.getElementById("humShow").innerHTML = roundToTwo(currHum1);
        document.getElementById("timeCollected").innerHTML = latestTime;

      });
      }

      function updateData() // Function that updates the data by retriving only the lastest data from the previous time.
      {
      $.getJSON("http://sbsrv1.cs.nuim.ie/lora/list.php?node=08-00-AA-00-C0-22-04-08&format=json&since"+latestTime, function(u)
      {
        updatedData = u[0].data;
        var updatedTime =  u[0].ts;
        latestTime = updatedTime;  // sets the most updated time to the lastest time.
        var len2 = u[0].data.length;

        if (len2==6) // This separates the data into the temp and humidity.
        {
          var tempNew2 = updatedData.substring(0, 3);
          var humNew2 = updatedData.substring(3, 7);
        }
        else if (len2==8) //This is for when the temp and or humidity are above a certain figure.
        {
          var tempNew2 = updatedData.substring(0, 4);
          var humNew2 = updatedData.substring(4, 8);
        }
        else
        {
          console.log("There is something wrong with your data array length");
        }

        var currTemp2 = (parseInt(tempNew2, 16)/100);
        var currHum2 = (parseInt(humNew2, 16)/100);

        //document.getElementById("tempShow").innerHTML = roundToTwo(currTemp2);
        //document.getElementById("humShow").innerHTML = roundToTwo(currHum2);
        document.getElementById("timeCollected").innerHTML = updatedTime;

      });
      }

      setInterval(updateData, 10000);  // Interval of 10 seconds between updating data.
    </script>

</body>

</html>
